<script>
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwhzb8rjVSppT2sTTj_Bm_SRjtSFlI5RsUvxLV2SHZ-bE48sh30ImvF65irzRRc_z4n/exec';

  function toggleClientField() {
    const type = document.getElementById('taskType').value;
    document.getElementById('clientDiv').classList.toggle('hidden', type !== 'Client');
    document.getElementById('categoryDiv').classList.toggle('hidden', type !== 'Internal');
    document.getElementById('clientName').required = type === 'Client';
  }

  document.getElementById('taskForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const responseDiv = document.getElementById('response');
    responseDiv.style.display = 'none';
    responseDiv.className = '';

    const data = {
      mode: 'newTask',
      title: document.getElementById('title').value.trim(),
      owner: document.getElementById('owner').value.trim(),
      ownerEmail: document.getElementById('ownerEmail').value.trim(),
      dueDate: document.getElementById('dueDate').value,
      taskType: document.getElementById('taskType').value,
      clientName: document.getElementById('clientName').value.trim() || undefined,
      clientOrCategory: document.getElementById('categoryName').value.trim() || undefined
    };

    try {
      const res = await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },  // This fixes CORS preflight!
        body: JSON.stringify(data),
        mode: 'no-cors'  // Extra safety â€“ allows success even if no CORS headers returned
      });

      // Since mode: 'no-cors', we can't read response body, but success = no network error
      responseDiv.style.display = 'block';
      responseDiv.className = 'success';
      responseDiv.innerHTML = `<strong>Success!</strong><br>
        Task created successfully!<br>
        Check your Trello board and spreadsheet for the new task.<br><br>
        (Task ID will appear in Trello card title)`;
      document.getElementById('taskForm').reset();
      toggleClientField();

    } catch (err) {
      responseDiv.style.display = 'block';
      responseDiv.className = 'error';
      responseDiv.textContent = 'Network error: ' + err.message;
    }
  });
</script>
